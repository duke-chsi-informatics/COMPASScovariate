---
title: "Including Antibody Covariates in RV144"

author:

                - "Frances Hung"

                - "Biostatistics, Epidemiology and Research Design (BERD) Core"

                - "Center for Human Systems Immunology (CHSI)"

date: "`r  Sys.Date()`"

output:

  html_document:

    toc: true

    toc_float: true

    number_sections: true
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE,message = FALSE)
options(knitr.duplicate.label = 'allow')

```

```{r Baseinfo,eval=FALSE}

#General info ----------------------

#

# Created: 2022-02-09

#

# Author: Frances Hung

#

# Program: //duhs-vclin-nc1/dusom_biostats_fs/Data/biostatscore/

#             CRU/Immunology Center/

#             Palmer/

#             COMPASS-covar/compass-covariate/incubator/

#             Rep-5-COMPASScovarAim2.RMD

#

# Description: Check overlap between flow and antibody data, then run COMPASS vs. COMPASS-covar analysis for Aim 2 CTOT patients.

#--- --- --- --- --- --- --- --- --- --- --- --- ---

#--- --- --- --- --- --- --- --- --- --- --- --- ---

```

```{r libs,message=FALSE, warning=FALSE, include=F, results='asis'}



library(lubridate)
library(kableExtra)
library(survival)
library(devtools)
library(readxl)
library(ggpubr)
library(Rcpp)
library(coda)
library(superheat)
library(DT)
library(COMPASS)
library(tidyverse)


# the RDATA file provided by Lynn containing original paper's COMPASS object
load(file="~/CHSI/PackageDev/COMPASScovariate/incubator/Frances/Data/rv144-2023-02-09.rda")

#unstim counts
nU <- rv144$data$n_u %>% as.data.frame()
#stim counts
nS <- rv144$data$n_s %>% as.data.frame()
#covariates
meta <- rv144$data$meta %>%
  select(-c(PFS, FS))

#########################################################
# Filter out patients missing Luminex here: none
#########################################################


# aggregate nS and nU into one flow matrix
flow_agg <- nU %>% mutate(Stimulation="noStim") %>%
  rownames_to_column(var="PTID") %>%
  rbind(nS %>% mutate(Stimulation="Stim") %>%
  rownames_to_column(var="PTID"))  %>%
  arrange(PTID)


#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Will get from package later
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
source("~/CHSI/PackageDev/COMPASScovariate/R/COMPASS-covariate.R")
source("~/CHSI/PackageDev/COMPASScovariate/R/updatebeta.R")
source("~/CHSI/PackageDev/COMPASScovariate/R/utils.R")

```

# Introduction

We consider `r nrow(meta)` RV144 patients:

- Sex (sex: 0 or 1)
- Risk (risk.medium, risk.high)
- Age (age: Age <=20, Age >=26, Age 21-25)
- IgAprim (the binding of plasma IgA antibodies to Env)
- V2prim (the binding of IgG antibodies to variable region 2 (V2) of the gp120 Env)
- Vaccine (vaccine: PLACEBO or VACCINE)
- Stratum number (based on sex, # vaccines received out of 4) from https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3371689/)

In the original COMPASS paper, PFS and FS scores were used as covariates in logistic and Cox-PH models, along with sex, risk groups, and 5 other primary variables. The original RV144 paper finds that IgA binding and V2 binding are directly and inversely correlated with infection.

When we run COMPASS-covar, we only use Luminex as a covariate in order to potentially improve PFS score estimates. We don't cut gates for now because all of the gates pass the sparsity condition.


```{r, options}

# raw antibody data cleaned so key field names match up with demographic DF
antibodyDF <- meta %>%
  arrange(PTID) %>%
  select(PTID, Luminex)
```

```{r funcs, options}


#########################################################
# Flow gate-related functions
#########################################################

#------------------------------------------------------
# FUNCTION for getting categories matrix for flow counts
# @params: flow DF
# @output: category matrix
#------------------------------------------------------
getCats <- function(stim) {
  # finding marker names and making category count matrix
marker_names <- unique(
    unlist( strsplit( gsub("!", "", colnames(stim)), "&", fixed=TRUE ) )
  )
  n_markers <- length(marker_names)

  cats <- as.data.frame( matrix(0, nrow=ncol(stim), ncol=length(marker_names)))
  rownames(cats) <- colnames(stim)
  colnames(cats) = marker_names

  for (i in seq_along(cats)) {
    #cats[, i] <- as.integer(grepl( paste0( colnames(cats)[i], "+" ), rownames(cats), fixed=TRUE ))
    cats[,i] <-
      as.integer(!grepl(paste0("!",colnames(cats)[i],"(&|$)+"),rownames(cats),fixed =
                          FALSE))
  }
  cats$Counts <- apply(cats, 1, sum)
  
  cats <- as.matrix(cats)
}

#------------------------------------------------------
# FUNCTION for cutting gates by sparsity
# @params: full flow DF (nostim and stim), included TheIDs
# @output: flow DF without sparse gates
#------------------------------------------------------
cutGates <- function(flowDF, includedIDs=flowDF$PTID, negGate) {
  # gate names to be excluded
  excludedCellCats <- flowDF %>%
    filter(PTID %in% includedIDs) %>%
    select(Stimulation,contains("&")) %>%
    filter(Stimulation=="noStim") %>%
    select(!where(function(x) sum(x>=5)>=2)) %>%
    colnames()
  
  # combined excluded cell counts
  excludedCellCounts <- data.frame(exCount=flowDF %>% 
  filter(PTID %in% includedIDs) %>%
  select(all_of(excludedCellCats)) %>%
  rowSums())
  
  return(flowDF %>% 
  filter(PTID %in% includedIDs) %>%
  select(contains("&")) %>%
# exclude sparse categories
  select(-all_of(excludedCellCats)) %>%
# add back excluded cells as part of all-negative gate
  cbind(excludedCellCounts) %>%
  mutate(across(matches(negGate), ~ .x + exCount)) %>%
  select(-exCount) %>%
# add visit and stimulation information
  cbind(flowDF %>% 
  filter(PTID %in% includedIDs) %>% select(PTID, Stimulation)) %>%
  relocate(PTID, Stimulation))
}


#---------------------------------------------------------------
# FUNCTION for getting difference in flow frequency of cut gates
# stim-noStim
# TODO: fix to use reframe instead 3/21
#---------------------------------------------------------------
flow_freqDiffs <- function(flowDF_cut) {
  # calculate freq of cut gates
  flowDF_freqs <- flowDF_cut %>%
    mutate(sumCounts = rowSums(across(contains("&")))) %>%
  # proportion across all gates 
    mutate(across(contains("&"), ~ .x/sumCounts)) %>%
    select(-c(sumCounts)) 
  
  #frequencies sum to 100
  # flowDF_freqs %>% select(contains("Freq")) %>% rowSums()
  
  #get differences in frequencies for each patient
  flowDF_freqDiffs <- flowDF_freqs %>%
    group_by(PTID) %>%
    summarise(across(contains("&"), ~ .x-lag(.x))) %>%
    drop_na()
}

#--------------------------------------------------------------------------------
# FUNCTION for plotting correlation of transformed antibodies with flow frequency differences
#--------------------------------------------------------------------------------
corrPlot <- function(flowDF_cut, antibodyDat) {

# differences in flow freq
flowDF_freqDiffs <- flow_freqDiffs(flowDF_cut)


# transformed antibody vs. flow correlation plot
corPlot <- cor(flowDF_freqDiffs %>%
  inner_join(antibodyDat) %>% ungroup() %>% select(-c(PTID))) %>%
  as.data.frame() %>%
  rownames_to_column() %>%
# get rid of unneccessary cor comparisons: want flow vs. antibody only
  filter(str_detect(rowname, "&")) %>%
  select(-contains("&")) %>%
# pivot longer for geom_tile
  pivot_longer(cols = -rowname, 
               names_to = "Antibody Measure",
               values_to = "Correlation") %>%
  dplyr::rename(Gate=rowname) %>%
  simpGates() %>%
  ggplot(aes(x=`Antibody Measure`, y=Gate, fill = `Correlation`)) +
  geom_tile() + theme(axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1)) +
  scale_fill_gradient2(low = "purple", mid= "white",high = "red") +
  ggtitle("Correlation between Gate Differences and Transformed Antibody Measures")

return(corPlot)
}






```

## Logging/Scaling Antibody Measures

We log-scale Luminex because it ranges from 0-1. The below histogram  shows the untransformed covariates and the violin plot shows the covariates after scaling the logged Luminex (if Luminex = 0, then we take log(Luminex + 0.001)).


```{r ex-scale-log, options}

antibodyDF %>%
  pivot_longer(cols = -c(PTID), names_to = "Vars", values_to = "values") %>%
  drop_na() %>%
  ggplot(aes(x= values)) + 
  geom_histogram() + facet_wrap(.~Vars, scales = "free") +
  ggtitle("Antibody Measures") +
  xlab("Value")

antibodyDF_transf <- antibodyDF %>%
  mutate(Luminex = ifelse(Luminex==0, scale(log(Luminex + 0.001)),
                          Luminex))

#checking log and scale work correctly
# antibodyDF_transf %>%
#   summarize(across(-PTID, ~mean(.x, na.rm = TRUE)))
# 
# antibodyDF_transf %>%
#   summarize(across(-PTID, ~sd(.x, na.rm = TRUE)))


```




```{r cut-flow, fig.height=10}

# flow_all <- nU_unfiltered %>% as.data.frame() %>% mutate(Stimulation="noStim") %>%
#   rownames_to_column(var="PTID") %>%
#   rbind(nS_unfiltered %>% as.data.frame() %>% mutate(Stimulation="Stim") %>%
#   rownames_to_column(var="PTID"))  %>%
#   arrange(PTID)

# flow data with cut gates
#flowDat_cut <- cutGates(flow_agg, "!TNFa&!IFNg&!IL4&!IL2&!CD154&!IL17a")

# flow_freqDiffs(flow_agg) %>%
#   pivot_longer(-PTID, names_to = "Gate", values_to = "Diffs") %>%
#   inner_join(meta_unfiltered) %>%
#   ggplot(aes(y=Diffs, x=vaccine)) + geom_boxplot() +
#   facet_wrap(.~Gate, scales = "free", ncol=4)

```

Below is a closer look at the transformed antibody measures for the `r nrow(antibodyDF_transf)` patients in question. The antibody measures are colored by whether an event (HIV infection) occurred or not. We have `r antibodyDF_transf %>% inner_join(meta %>% select(PTID, infect)) %>% filter(!str_detect(toupper(infect), "NON")) %>% nrow()` patients who are infected out of `r nrow(antibodyDF_transf)`.

```{r ex-scale-log-Aim2, options}
antibodyDF_transf %>%
  inner_join(meta %>% select(PTID, infect)) %>%
  pivot_longer(cols = -c(PTID, infect), names_to = "Vars", values_to = "values") %>%
  drop_na() %>%
  mutate(event=as.factor(infect)) %>%
  dplyr::rename(Infection=event) %>%
  ggplot(aes(x= Infection, y = values, color = Infection)) + 
  geom_violin() + facet_wrap(.~Vars, scales = "free") +
  xlab("Infection")

```
We look at the placebo flow differences to see if they could potentially drastically change our results:



```{r COMPASS-orig, options}
#-------------------------------------------------------------------------
# FUNCTION for COMPASS 
# takes in flow data frame, and suffix for naming rds file
# TODO: fix to use COMPASS discrete?
#-------------------------------------------------------------------------
COMPASS_orig <- function(flowDF_cut, metaDF, postfix) {
  
  # magic code to make it work...
  n_s <- flowDF_cut %>% filter(Stimulation=="Stim") %>%
    arrange(PTID) %>%
    `rownames<-`(.$PTID) %>%
    select(-c(PTID, Stimulation)) %>%
    as.matrix()
  
  n_u <- flowDF_cut %>% filter(Stimulation=="noStim") %>%
    arrange(PTID) %>%
    `rownames<-`(.$PTID) %>%
    select(-c(PTID, Stimulation)) %>%
    as.matrix()
  
  categories <- getCats(flowDF_cut %>% filter(Stimulation=="noStim") %>%
    arrange(PTID) %>% 
    `rownames<-`(.$PTID) %>%
    select(-c(PTID, Stimulation)))
  
  I <- nrow(n_s)
  
  # n_s (I x K), n_u (I x K), iters, replications, X (I x J)
  starttime = Sys.time()
  COMPASScovarobj <- SimpleCOMPASS(n_s = n_s,
                                   n_u = n_u,
                                   meta=metaDF,
                                   individual_id = "PTID",
                                   iterations = 200000,
                                   replications = 7)
  endtime= Sys.time()

saveRDS(list(COMPASScovarobj = COMPASScovarobj, runTime = endtime-starttime),
          paste0("~/CHSI/PackageDev/COMPASScovariate/incubator/Frances/Data/rv144COMPASSorig200000_seed100_new",postfix,".rds"))

  
# saveRDS(list(pp65COMPASSAim2_diffs = COMPASScovarAim2_diffs, runTime = endtime-starttime),
#           paste0("//duhs-vclin-nc1/dusom_biostats_fs/Data/biostatscore/CRU/Immunology Center/Palmer/Pro000102592/COMPASS-covar/data/pp65Aim2diffsCOMPASS200000_seed100_new",postfix,".rds"))
rm(COMPASScovarobj)

}
```


```{r compass-cov, options}
set.seed(100)

# antibody samples for pre-transplant
X <- antibodyDF_transf %>% 
  select(-c(PTID)) %>% as.matrix()


#-------------------------------------------------------------------------
# FUNCTION for COMPASS covariate
# takes in flow data frame, and suffix for naming rds file
#-------------------------------------------------------------------------
COMPASS_covar <- function(flowDF_cut, X, postfix) {
  
  # magic code to make it work...
  n_s <- flowDF_cut %>% filter(Stimulation=="Stim") %>%
    arrange(PTID) %>%
    `rownames<-`(.$PTID) %>% select(-c(PTID, Stimulation)) %>%
    as.matrix()
  n_u <- flowDF_cut %>% filter(Stimulation=="noStim") %>%
    arrange(PTID) %>%
    `rownames<-`(.$PTID) %>% select(-c(PTID, Stimulation)) %>%
    as.matrix()
  categories <- getCats(flowDF_cut %>% filter(Stimulation=="noStim") %>%
    arrange(PTID) %>%
    `rownames<-`(.$PTID) %>% select(-c(PTID, Stimulation)))
  I <- nrow(n_s)
  
  # n_s (I x K), n_u (I x K), iters, replications, X (I x J)
  starttime = Sys.time()
  COMPASScovarobj <- .COMPASS.covariate(n_s=n_s, n_u=n_u,
                                         categories = categories,
                                         iterations = 200000, replications = 7, X = X)
  endtime= Sys.time()

saveRDS(list(COMPASScovarobj = COMPASScovarobj, runTime = endtime-starttime),
          paste0("~/CHSI/PackageDev/COMPASScovariate/incubator/Frances/Data/rv144COMPASScovar200000_seed100_new",postfix,".rds"))

  
# saveRDS(list(pp65COMPASSAim2_diffs = COMPASScovarAim2_diffs, runTime = endtime-starttime),
#           paste0("//duhs-vclin-nc1/dusom_biostats_fs/Data/biostatscore/CRU/Immunology Center/Palmer/Pro000102592/COMPASS-covar/data/pp65Aim2diffsCOMPASS200000_seed100_",postfix,".rds"))
rm(COMPASScovarobj)

}
```

```{r beta-heatmap}

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# FUNCTION for beta table of median/95% confidence intervals
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
betaTable <- function(COMPASScovarobj, flowDF_cut, antibodyDat, percburn=0) {
  

nSamp <- nrow(COMPASScovarobj$alpha_s)
betaSamps <- COMPASScovarobj$beta[,,(round(nSamp*percburn)+1):nSamp]
K1 = nrow(betaSamps[,,1])
P1 = ncol(betaSamps[,,1])

matrix(apply(betaSamps, c(1,2), function(x) quantile(x, c(0.025, 0.975))), nrow = nrow(betaSamps[,,1])) %>%
  as.data.frame()

CIDF <- matrix(paste0(round(apply(array(unlist(betaSamps), c(K1, P1, nSamp-round(nSamp*percburn)+1)), c(1,2), function(x) quantile(x, 0.5)),2), "(",
round(apply(array(unlist(betaSamps), c(K1, P1, nSamp-round(nSamp*percburn)+1)), c(1,2), function(x) quantile(x, 0.025)),2), ", ",
round(apply(array(unlist(betaSamps), c(K1, P1, nSamp-round(nSamp*percburn)+1)), c(1,2), function(x) quantile(x, 0.975)),2), ")"), nrow = nrow(betaSamps[,,1])) %>%
  as.data.frame() %>%
  mutate(Gate = flowDF_cut %>%  colnames() %>% .[1:K1]) %>%
simpGates()

colnames(CIDF) <- c("Intercept", colnames(antibodyDat), "Gate")
  
CIDF %>%
  select("Gate", "Intercept", sort(colnames(.))) %>%
  datatable(rownames = FALSE, options = list(
  pageLength = 5, autoWidth = TRUE))

}

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Function for beta heatmap of point estimates
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
beta_heatmap <- function(COMPASScovarobj, flowAim2_cut, antibodyDat, percburn=0.5) {

nSamp <- nrow(COMPASScovarobj$alpha_s)
betaSamps <- COMPASScovarobj$beta[,,(round(nSamp*percburn)+1):nSamp]
K1 = nrow(betaSamps[,,1])
P1 = ncol(betaSamps[,,1])


CIDF <- matrix(apply(betaSamps, c(1,2), function(x) quantile(x, 0.5)), nrow = nrow(betaSamps[,,1])) %>%
  as.data.frame() %>%
  mutate(Gate = flowAim2_cut %>% colnames() %>% .[1:K1]) 
  

colnames(CIDF) <- c("Intercept", colnames(antibodyDat), "Gate")
  
CIDF %>%
  select("Gate", "Intercept", sort(colnames(.))) %>%
  simpGates() %>%
  pivot_longer(cols=-Gate, names_to = "Antibody", 
               values_to = "Effect") %>%
  mutate(Antibody = relevel(factor(Antibody), ref = "Intercept")) %>%
  ggplot(aes(x=Antibody, y=Gate, fill = Effect)) +
  geom_tile() + 
  theme_classic() +
  scale_fill_gradient2(low = "purple", mid= "white",high = "red") +
  ggtitle("Associated Antibody Effects on Flow Gate Reactivity")
  
}

```



```{r gamma-diffs,fig.height=12}
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# FUNCTION for joining df with meta-data
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
joinMeta <- function(df, metaDF) {
  df %>%
    left_join(metaDF %>% select(PTID, infect)) %>%
  mutate(infect = ifelse(!str_detect(toupper(infect), "NON"), "Infected", "Not Infected"))
}

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# FUNCTION for renaming gates for ease of reading
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
simpGates <- function(df) {
  df %>%
    mutate(Gate = map_chr(str_extract_all(Gate, "\\!|&\\!|&")
                          , ~ str_c(.x,collapse = "")) %>%
             str_replace_all("\\!|(&\\!)","-") %>% str_replace_all("&","\\+")) %>%
  # missing + for first cytokine if it is positive
    mutate(Gate = ifelse(nchar(Gate)==5, paste0("+", Gate), Gate))
}
  
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# FUNCTION for getting mean gamma with default 50% burn-in, no thin
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
mean_gam <- function(gammaSamps, percburn) {
  N=dim(gammaSamps)[3]
  Nburn=round(percburn*N);
  Mgamma = mat.or.vec(dim(gammaSamps)[1],dim(gammaSamps)[2]);
  Nseq = seq(Nburn+1,N,by=1)
  for (ttt in Nseq) {
    Mgamma = Mgamma + gammaSamps[,,ttt]; #thining
  }
  Mgamma = Mgamma/(N-Nburn);
  return(Mgamma)
}

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# FUNCTION for boxplot comparing COMPASS vs. COMPASS-covar gamma
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
compareGammaBoxplot <- function(pp65COMPASSobj, COMPASScovarobj, metaDF, percBurn=0.5) {

# Original RV144 COMPASS has extra obs
OGmeanGam <- mean_gam(pp65COMPASSobj$gamma[metaDF$PTID,,], percBurn) %>%
  `colnames<-`(colnames(COMPASScovarobj$mean_gamma))
CovarmeanGam <- mean_gam(COMPASScovarobj$gamma, percBurn) %>%
  `colnames<-`(colnames(COMPASScovarobj$mean_gamma))

OGmeanGam %>%
  as.data.frame() %>%
  rownames_to_column(var = "PTID") %>%
# join with event status
  left_join(metaDF %>% select(PTID, infect)) %>%
  pivot_longer(cols = -c(PTID, infect), names_to = "Gate", 
               values_to = "MeanGamma") %>%
  mutate(COMPASStype="Original",
         event = ifelse(!str_detect(toupper(infect),"NON"), "Infected", "Uninfected")) %>%
  rbind(CovarmeanGam %>%
  as.data.frame() %>%
  mutate(PTID = rownames(OGmeanGam)) %>%
# join with event status
  left_join(metaDF %>% select(PTID, infect)) %>%
  pivot_longer(cols = -c(PTID, infect), names_to = "Gate", 
               values_to = "MeanGamma") %>%
  mutate(COMPASStype="Covar",
         event = ifelse(!str_detect(toupper(infect),"NON"), "Infected", "Uninfected"))) %>%
    mutate(COMPASStype = factor(COMPASStype, levels=c("Original", "Covar"))) %>%
    mutate(Gate = map_chr(str_extract_all(Gate, "&\\!|&")
                          , ~ str_c(.x,collapse = "")) %>%
             str_replace_all("&\\!","-") %>% str_replace_all("&","\\+")) %>%
  # missing + for first cytokine if it is positive
    mutate(Gate = ifelse(nchar(Gate)==5, paste0("+", Gate), Gate)) %>%
  # boxplots faceted by gate, colored by COMPASS type
  ggplot(aes(x=COMPASStype, y=MeanGamma, color=COMPASStype)) + geom_boxplot() +
    geom_point() +
  geom_line(aes(group=PTID), color="black", alpha=0.5) +
  facet_grid(cols = vars(event),rows = vars(Gate))
  
}

#compareGammaBoxplot(pp65COMPASSAim2, COMPASScovarAim2_diffs)
```

```{r beta-trace}

# To plot traceplots of beta, we should get rid of the first 50%, which is simple
# then we should take the remaining and thin out to look at every 33th
# then we should pivot longer so we have columns for gate, antibody, and value
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Get desired samples, leaving out the first 50% as burn-in
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
getBetaLong <- function(compasscovarBeta, X, percburn, thin=10) {
  #--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
  # Row-binding beta samples for all K gates
  #--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
  N <- dim(compasscovarBeta)[3]
  P <- dim(compasscovarBeta)[2]
  K <- dim(compasscovarBeta)[1]
  
  trimmedList<-compasscovarBeta[,,seq(1, N, by=thin)] 
  finaltrimmedList <- trimmedList[,,seq(percburn*dim(trimmedList)[3]+1,dim(trimmedList)[3])]
  tempParamlist = vector("list", length = dim(finaltrimmedList)[3])
  
  for (n in 1:dim(finaltrimmedList)[3]) {
    gateParamk <- finaltrimmedList[,,n] %>% 
      `colnames<-`(c("Intercept", colnames(X))) %>%
      as.data.frame() %>%
      rownames_to_column() %>%
      pivot_longer(-rowname, names_to = "variable") %>% 
      mutate(iter = n)
    
    tempParamlist[[n]] <- gateParamk
  }
  
  paramSamps <- do.call(rbind,tempParamlist)
  
  return(paramSamps)
}

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Plot beta trace plots
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---

betaTrace <- function(compasscovarBeta, X, gateNames, percburn=0.5, thin=10) {
  
  betaSamps <- getBetaLong(compasscovarBeta, X, percburn, thin) %>%
    mutate(across(where(is.character), ~as.factor(.x)))
  
  levels(betaSamps$rowname) <- gateNames
  
  betaSamps %>%
    dplyr::rename(Gate=rowname) %>%
    simpGates() %>%
    ggplot(aes(x=iter, y=value))  +
    geom_line() +
    facet_grid(rows = vars(Gate), cols = vars(variable) ) +
    theme(axis.text.x=element_blank(), axis.ticks.x = element_blank(),
          strip.text.y.right = element_text(angle = 0))
}


#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Get desired samples, leaving out the first 50% as burn-in
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
getGammaLong <- function(compasscovarGamma, ns, percburn, thin=10) {
  #--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
  # Row-binding beta samples for all K gates
  #--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
  N <- dim(compasscovarGamma)[3]
  P <- dim(compasscovarGamma)[2]
  K <- dim(compasscovarGamma)[1]
  
  trimmedList<-compasscovarGamma[,,seq(1, N, by=thin)] 
  finaltrimmedList <- trimmedList[,,seq(percburn*dim(trimmedList)[3]+1,dim(trimmedList)[3])]
  tempParamlist = vector("list", length = dim(finaltrimmedList)[3])
  
  for (n in 1:dim(finaltrimmedList)[3]) {
    gateParamk <- finaltrimmedList[,,n] %>% 
      `colnames<-`(colnames(ns)) %>%
      as.data.frame() %>%
      rownames_to_column(var="PTID") %>%
      pivot_longer(-PTID, names_to = "Gate") %>% 
      mutate(iter = n)
    
    tempParamlist[[n]] <- gateParamk
  }
  
  paramSamps <- do.call(rbind,tempParamlist)
  
  return(paramSamps)
}

#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# Plot gamma trace plots: we plot all patients in same plot for each gate
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---

gammaTrace <- function(compasscovarGamma, ns, percburn=0.5, thin=10) {
  
  gammaSamps <- getGammaLong(compasscovarGamma, ns, percburn, thin) %>%
    mutate(across(where(is.character), ~as.factor(.x)))
  
  
  gammaSamps %>%
    simpGates() %>%
    ggplot(aes(x=iter, y=value))  +
    geom_line() +
    facet_grid(rows = vars(Gate) ) +
    theme(axis.text.x=element_blank(), axis.ticks.x = element_blank(),
          strip.text.y.right = element_text(angle = 0))
}

```

# COMPASS vs. COMPASS-covariate: Mean Gamma and Beta

## Antibody COMPASS-covar


```{r todebug-orig, include=FALSE}

n_s <- flow_agg %>% filter(Stimulation=="Stim") %>%
    arrange(PTID) %>%
  `rownames<-`(.$PTID) %>%
    select(-c(PTID, Stimulation)) %>%
    as.matrix()
  
  n_u <- flow_agg %>% filter(Stimulation=="noStim") %>%
    arrange(PTID) %>%
    `rownames<-`(.$PTID) %>%
    select(-c(PTID, Stimulation)) %>%
    as.matrix()
  
  categories <- getCats(flow_agg %>% filter(Stimulation=="noStim") %>%
    arrange(PTID) %>% 
    `rownames<-`(.$PTID) %>%
    select(-c(PTID, Stimulation)))
  I <- nrow(n_s)
  
  # n_s (I x K), n_u (I x K), iters, replications, X (I x J)
  starttime = Sys.time()
  COMPASScovarobj <- COMPASS::SimpleCOMPASS(n_s = n_s,
                                   n_u = n_u,
                                   meta = meta,
                                   individual_id = "PTID",
                                   iterations = 10,
                                   replications = 1)
  endtime= Sys.time()
```

```{r compass-orig, fig.height=10}
set.seed(100)
#COMPASS_orig(flow_agg, meta,"cut")

COMPASSorig<- readRDS("~/CHSI/PackageDev/COMPASScovariate/incubator/Frances/Data/rv144COMPASSorig200000_seed100_newcut.rds")$COMPASScovarobj$fit


# mean gamma original
mean_gamma_OG <- COMPASSorig$mean_gamma %>%
  as.data.frame() %>%
  rownames_to_column(var="PTID") %>%
  pivot_longer(-PTID, names_to = "Gate", values_to = "mean_gam") %>%
  mutate(Gate = map_chr(str_extract_all(Gate, "\\!|&\\!|&")
                          , ~ str_c(.x,collapse = "")) %>%
             str_replace_all("\\!|(&\\!)","-") %>% str_replace_all("&","\\+")) %>%
  # missing + for first cytokine if it is positive
    mutate(Gate = ifelse(nchar(Gate)==5, paste0("+", Gate), Gate))

#RV144COMPASSorig <- rv144$fit

#compareGammaBoxplot(COMPASSorig, COMPASScovarV2Lum, meta)
```

### Reference DFs for gate and patient names

```{r gate-names-df, options}
gateRefDF <- data.frame(orig_names=colnames(n_s), names_idx = 1:ncol(n_s)) %>%
   mutate(Gate = map_chr(str_extract_all(orig_names, "\\!|&\\!|&")
                          , ~ str_c(.x,collapse = "")) %>%
             str_replace_all("\\!|(&\\!)","-") %>% str_replace_all("&","\\+")) %>%
  # missing + for first cytokine if it is positive
    mutate(Gate = ifelse(nchar(Gate)==5, paste0("+", Gate), Gate))

patsRefDF <- data.frame(pat_names=rownames(n_s), 
                        pat_idx = 1:nrow(n_s))
```

### Comparing Mean Gamma (Covariate vs. Original)

The below boxplots compare the mean gamma values estimated by COMPASS-covariate and original COMPASS. The cytokines we gate by are:

- TNFa
- IFNg
- IL4
- IL2
- CD154
- IL17a

```{r todebug, include=FALSE}

n_s <- flow_agg %>% filter(Stimulation=="Stim") %>%
    arrange(PTID) %>%
  `rownames<-`(.$PTID) %>%
    select(-c(PTID, Stimulation)) %>%
    as.matrix()
  
  n_u <- flow_agg %>% filter(Stimulation=="noStim") %>%
    arrange(PTID) %>%
    `rownames<-`(.$PTID) %>%
    select(-c(PTID, Stimulation)) %>%
    as.matrix()
  
  categories <- getCats(flow_agg %>% filter(Stimulation=="noStim") %>%
    arrange(PTID) %>% 
    `rownames<-`(.$PTID) %>%
    select(-c(PTID, Stimulation)))
  
  I <- nrow(n_s)
  
  # n_s (I x K), n_u (I x K), iters, replications, X (I x J)
  starttime = Sys.time()
  COMPASScovarobj <- .COMPASS.covariate(n_s=n_s, n_u=n_u,
                                         categories = categories,
                                         iterations = 10, replications = 1, X = X)
  endtime= Sys.time()
```

```{r compass-covar-CD4_notsparse, fig.height=10}
set.seed(100)
#COMPASS_covar(flow_agg, X, "Lum")

COMPASScovarV2Lum<- readRDS("~/CHSI/PackageDev/COMPASScovariate/incubator/Frances/Data/rv144COMPASScovar200000_seed100_newLum.rds")$COMPASScovarobj

beta_sum <- 0
betaSamps <- COMPASScovarV2Lum$beta
for(ii in 1:dim(betaSamps)[3]) {
  beta_sum = beta_sum + betaSamps[,,ii]
}

# mean beta
mean_beta = (beta_sum/dim(betaSamps)[3]) %>%
  as.data.frame() %>%
  cbind(Gate=colnames(COMPASScovarV2Lum$mean_gamma)[1:nrow(.)]) %>%
  mutate(Gate = map_chr(str_extract_all(Gate, "\\!|&\\!|&")
                          , ~ str_c(.x,collapse = "")) %>%
             str_replace_all("\\!|(&\\!)","-") %>% str_replace_all("&","\\+")) %>%
  # missing + for first cytokine if it is positive
    mutate(Gate = ifelse(nchar(Gate)==5, paste0("+", Gate), Gate))

# mean gamma covariate
mean_gamma_covar <- COMPASScovarV2Lum$mean_gamma %>%
  as.data.frame() %>%
  rownames_to_column(var="PTID") %>%
  pivot_longer(-PTID, names_to = "Gate", values_to = "mean_gam") %>%
  mutate(Gate = map_chr(str_extract_all(Gate, "\\!|&\\!|&")
                          , ~ str_c(.x,collapse = "")) %>%
             str_replace_all("\\!|(&\\!)","-") %>% str_replace_all("&","\\+")) %>%
  # missing + for first cytokine if it is positive
    mutate(Gate = ifelse(nchar(Gate)==5, paste0("+", Gate), Gate))

compareGammaBoxplot(COMPASSorig, COMPASScovarV2Lum, meta)
```

### Patients Who Change

We look in more detail at patients who change; we'd like to see where all their flow and antibody values fall and whether they differ visibly from the people who don't change. Below are histograms of flow and antibody values with colored (by number of gates which differ significantly) lines at the values for each patient of interest.

Quite a few patients have at least one gate for which estimated gamma changed across the 0.5 threshold, but there aren't any obvious visual patterns.


```{r compareGam}
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
# FUNCTION for dataframe for COMPASS vs. COMPASS-covar gamma
#--- --- --- --- --- --- --- --- --- --- --- --- --- --- --- ---
compareGammaDF <- function(pp65COMPASSAim2, COMPASScovarAim2, metaDF, percBurn=0.5) {

  # mean gamma with 50% burn-in: gammas are zero when they should be
  OGmeanGam <- mean_gam(pp65COMPASSAim2$gamma[metaDF$PTID,,], percBurn) %>%
    `colnames<-`(colnames(COMPASScovarAim2$mean_gamma))
  CovarmeanGam <- mean_gam(COMPASScovarAim2$gamma, percBurn) %>%
    `colnames<-`(colnames(COMPASScovarAim2$mean_gamma))

  OGmeanGam %>%
    as.data.frame() %>%
    rownames_to_column(var = "PTID") %>%
    # join with event status
    joinMeta(meta) %>%
    pivot_longer(cols = -c(PTID, infect), names_to = "Gate",
                 values_to = "MeanGamma") %>%
    mutate(COMPASStype="Original") %>%
    rbind(CovarmeanGam %>%
            as.data.frame() %>%
            mutate(PTID = rownames(OGmeanGam)) %>%
            joinMeta(meta)  %>%
  pivot_longer(cols = -c(PTID, infect), names_to = "Gate", 
               values_to = "MeanGamma") %>%
  mutate(COMPASStype="Covar")) %>% 
    mutate(COMPASStype = factor(COMPASStype, levels=c("Original", "Covar"))) %>%
    mutate(Gate = map_chr(str_extract_all(Gate, "\\!|&\\!|&")
                          , ~ str_c(.x,collapse = "")) %>%
             str_replace_all("\\!|(&\\!)","-") %>% str_replace_all("&","\\+")) %>%
  # missing + for first cytokine if it is positive
    mutate(Gate = ifelse(nchar(Gate)==5, paste0("+", Gate), Gate))
}
```


There are quite a few patients who have dramatic changes in mean gamma. The below sorted table of mean gammas, raw Luminex score, and scaled flow differences indicates that these dramatic changes consist of patients consist of people with either Luminex scores or large flow differences.

```{r mean-gamma-changes, fig.height=12}
#patients whose mean gamma changes past the 0.5 threshold for at least one gate
changingPats <- compareGammaDF(COMPASSorig, COMPASScovarV2Lum, meta) %>%
  pivot_wider(names_from = COMPASStype, 
              values_from = MeanGamma) %>%
  mutate(OGlessThreshold = Original < 0.5,
         CovarlessThreshold = Covar < 0.5,
         Flag = #(OGlessThreshold & !CovarlessThreshold) |
           #(!OGlessThreshold & CovarlessThreshold) |
           case_when(Original-Covar>0.25 ~ "Decrease",
                     Covar-Original>0.25 ~ "Increase",
                     TRUE ~ "None")) %>%
  filter(Flag!="None") %>% ungroup() %>%
  distinct()

#quantiles of differences
diffquants <- flow_freqDiffs(flow_agg) %>%
  ungroup() %>%
  pivot_longer(cols = -c(PTID), names_to = "Gate", values_to = "values") %>%
    simpGates() %>%
  drop_na() %>%
  arrange(Gate) %>%
  group_by(Gate) %>%
  mutate(medGate = median(values),
         quantDiff = percent_rank(values)) %>%
# join with flagged pats
  left_join(changingPats %>% select(PTID, Gate,Flag)) %>%
  replace_na(list(Flag="None")) %>%
# join with Luminex
  left_join(antibodyDF_transf) 

#percentage of people with positive differences in expression prop (ps-pu)
cutoffZero <- diffquants %>% mutate(zeroVal=values>0) %>% count(Gate,zeroVal) %>%
  group_by(Gate) %>%
  mutate(propThreshold=n/sum(n)) %>%
  filter(zeroVal == TRUE)

#########################################################
# plot quantile diffs vs. Luminex, colored by mean gamma diff
#########################################################

diffquants %>%
  # join with covariate coefficients for labels
  left_join(mean_beta) %>%
  # label with min and max diff in prop
  group_by(Gate) %>%
  mutate(maxDiff=max(values),
         minDiff=min(values)) %>% ungroup() %>%
  # label with proportion of patients with positive response
  left_join(cutoffZero) %>%
  mutate(lab=paste0(Gate, ", effect: ", round(V2,1), ", ", 
                    "%+: ",round(propThreshold,2),
                    ", max:", round(maxDiff,5))) %>%
  # join with diffs of mean gamma
  left_join(mean_gamma_OG %>% 
              left_join(mean_gamma_covar, by=c("PTID", "Gate"))) %>%
  mutate(mean_gam_diff = mean_gam.y-mean_gam.x) %>%
  ggplot(aes(x=quantDiff, y=Luminex, color=mean_gam_diff))+
  geom_point(alpha=0.4) + facet_wrap(.~lab, ncol = 4)  +
  scale_colour_gradient2() +
  labs(x="Quantile of Difference in Subset %", y= "Standardized Luminex",
       color="Mean Gamma Diff") +
  ggtitle("Mean Gamma", subtitle = "by Subset % Difference (quanticized) and Luminex")

ggsave("./Regression/Plots/quantDiffsvLumMGDiff.png", width = 12, height = 12)

#########################################################
# plot quantile diffs vs. Luminex, colored by flagged
#########################################################
diffquants %>%
  #mutate(Flag=ifelse(Flag,  "True", "False")) %>%
  # join with covariate coefficients for labels
  left_join(mean_beta) %>%
  # label with min and max diff in prop
  group_by(Gate) %>%
  mutate(maxDiff=max(values),
         minDiff=min(values)) %>% ungroup() %>%
  # label with proportion of patients with positive response
  left_join(cutoffZero) %>%
  mutate(lab=paste0(Gate, ", effect:", round(V2,1), ", ", 
                    "%+: ",round(propThreshold,2),
                    ", range:", round(minDiff,5),"-",round(maxDiff,5))) %>%
  ggplot(aes(x=quantDiff, y=Luminex, color=Flag))+
  geom_point(alpha=0.4) + facet_wrap(.~lab,
                                     ncol = 4) +
  labs(x="Quantile of Difference in Subset %", y= "Standardized Luminex",
       color="Significant Change") +
  ggtitle("Flagged Cell Subsets", subtitle = "by Subset % Difference (quanticized) and Luminex")

ggsave("./Regression/Plots/quantDiffsvLum.png", width = 25, height = 10)

#########################################################
# heatmap of mean gamma differences
#########################################################
toHM <- mean_gamma_OG %>% 
              left_join(mean_gamma_covar, by=c("PTID", "Gate")) %>%
  mutate(mean_gam_diff = mean_gam.y-mean_gam.x) %>%
  select(PTID,Gate, mean_gam_diff) %>%
  pivot_wider(names_from = PTID, values_from = mean_gam_diff)

toHM  %>%
  dplyr::select(-Gate) %>% as.matrix() %>%
  `row.names<-`(toHM$Gate) %>%
  superheat(#row.dendrogram = TRUE,
            yr=c(mean_beta$V2,NA),
            left.label.text.size = 2,
             heat.pal = c("#b35806", "white", "#542788"))

toHM  %>%
  dplyr::select(-Gate) %>% as.matrix() %>%
  `row.names<-`(toHM$Gate) %>%
  superheat(row.dendrogram = TRUE,
            left.label.text.size = 2,
             heat.pal = c("#b35806", "white", "#542788")) 
ggsave("./Regression/Plots/hm.png", width = 25, height = 10)

```

In all, `r changingPats %>% count(PTID) %>% nrow()` patients had at least one gate for which gamma changed significantly.

### Convergence

The acceptance rate for gamma for COMPASS is plotted on the below x-axis and the acceptance rate for gamma for COMPASS-covariate is plotted on the below y-axis.

```{r gamma-a-CD4}
cbind(x=COMPASSorig$A_gamma, y=COMPASScovarV2Lum$A_gamma) %>%
  as.data.frame() %>%
  ggplot(aes(x=x,y=y)) +
  geom_point() +
  geom_abline() +
  xlab("Original COMPASS Acceptance Rate") +
  ylab("COMPASS-covar Acceptance Rate") +
  ggtitle("Gamma Acceptance Rates")
```

We compare how much the gamma MCMC's converge. 

```{r gamma-mcmcs, fig.width=10}
ggarrange(gammaTrace(COMPASScovarV2Lum$gamma, n_s, thin=1000),
          gammaTrace(COMPASSorig$gamma, n_s, thin=1000))
```

We plot the gamma traceplots for the two gates with the most change in q-value (-+---- and -+-+--).

```{r twoGamTrace, options}
twoGatesMaxQChange <- which(colnames(n_s)%in%
                              c("!TNFa&IFNg&!IL4&!IL2&!CD154&!IL17a",
                                "!TNFa&IFNg&!IL4&IL2&!CD154&!IL17a"))

ggarrange(gammaTrace(COMPASScovarV2Lum$gamma[,twoGatesMaxQChange,],
                     n_s[,twoGatesMaxQChange], thin=100),
          gammaTrace(COMPASSorig$gamma[,twoGatesMaxQChange,],
                     n_s[,twoGatesMaxQChange], thin=100))

```


We plot the Geweke's statistic for the two gates' patients' gamma values.

```{r geweke, options}
patsForGeweke <- mean_gamma_OG %>% 
              left_join(mean_gamma_covar, by=c("PTID", "Gate")) %>%
  mutate(mean_gam_diff = mean_gam.y-mean_gam.x) %>%
  filter(Gate %in% c("-+----","-+-+--")) %>%
  # join with ref DFs
  left_join(patsRefDF %>% rename(PTID=pat_names)) %>%
  left_join(gateRefDF) %>%
  select(Gate, PTID, contains("idx")) %>%
  rowwise() %>%
  # get Geweke
  mutate(gewekeCovar=geweke.diag(COMPASScovarV2Lum$gamma[pat_idx, names_idx,])$z,
         gewekeOrig=geweke.diag(COMPASSorig$gamma[pat_idx,names_idx,])$z) 

patsForGeweke %>%
  rename(Covariate=gewekeCovar, Original=gewekeOrig) %>%
  pivot_longer(cols = c(Covariate, Original),
               names_to = "COMPASSType", 
               values_to= "gewScore") %>%
  group_by(COMPASSType, Gate) %>%
  mutate(label=paste0(Gate,", N=",sum(!is.na(gewScore)))) %>%
  ggplot(aes(x=gewScore)) +
  facet_wrap(COMPASSType~label) +
  geom_histogram() +
  labs(x="Geweke Score", y="Count", title="Geweke Scores for -+----, -+-+-- (N=262)")

ggsave("./Regression/Plots/geweke.png", width = 10, height = 8)
```

A traceplot of beta is below with a thin of 10 and the first 50% of samples excluded.

```{r beta-traceplot-CD4, fig.height=15}
betaTrace(COMPASScovarV2Lum$beta, 
          X = X,
          gateNames = colnames(n_s)) 
```

### Covariate-Flow Correlation and Estimated Effects

To get an idea of whether covariates will help in predicting gate reactivity, we do the following:

1.  Calculate the proportion of cells for each patient belonging to each of the gates (above).
2.  Take the difference between the Stim proportion and noStim proportion for each patient.
3.  Calculate the correlation between these differences for each gate and covariate measure.

Below, we create a correlation plot of differences in proportion of cells in each gate vs. each transformed covariate measure of interest. More colored cells indicate that an covariate is more correlated with reaction differences in the corresponding gate.

Underneath the correlation plot, we plot beta point estimates (the estimated effects of the covariate measures on the gamma estimates) produced by COMPASS-covariate. Formally, these are the estimated change in log-odds of gamma=1, given a 1-standard deviation increase in the covariate measure. There is a separate estimate for each gate and each covariate measure.

Note that in the effect plot, we include intercepts. These intercepts represent the estimated base log-odds of each gate reacting to stim, so we don't expect the actual colors to correspond between plots. We're more likely to see similar patterns in strength of color.

```{r beta-CD4_notsparse, options}
corrPlot(flow_agg,antibodyDF_transf)
beta_heatmap(COMPASScovarV2Lum, flow_agg %>% select(-PTID), X)
ggsave("./Regression/Plots/coefs.png")
```

To see whether any of these are meaningful, we can look at confidence intervals for the beta coefficients.

```{r betaTab-CD4, options}
betaTable(COMPASScovarV2Lum, flow_agg %>% select(-PTID), X)
```

As a visual check, we make scatterplots of Luminex vs. difference in flow gate proportion.

```{r scatterplot-sig-cd4, fig.height=20}

flow_freqDiffs(flow_agg) %>%
  pivot_longer(-PTID, names_to = "Gate", values_to = "FreqDiffs") %>%
  simpGates() %>%
  left_join(antibodyDF_transf) %>%
  joinMeta(meta) %>%
  ggplot(aes(x=Luminex, y = FreqDiffs, color=infect)) + geom_point(alpha=0.5) +
    facet_wrap(.~Gate, scales = "free", ncol=3)
```


```{r boxplot-flow-diffs, eval=FALSE}
# flow_freqDiffs(flowAim2_cut_CD4) %>%
#   select(-`CD4+CD107a-IFNg-IL-2-TNFa- | Freq`) %>%
#   pivot_longer(cols=-TheID, names_to="Gate", values_to = "Difference") %>%
#   ggplot(aes(x=Gate, y=Difference)) + geom_boxplot() +
#   coord_flip()

```



# PFS/FS Cox Models 

We can calculate PFS scores and FS scores for RV144 COMPASS-covar. 

We get two sets of PFS scores:

-   RV144 COMPASS original
-   RV144 COMPASS covariate

### PFS Scores

```{r}
PolyfunctionalityScore <- function(x, degree, n,percBurn=0.5) {
  
  xmeanGam <- mean_gam(x$gamma, percBurn) %>%
  `colnames<-`(colnames(x$mean_gamma))
  
  degree <- x$categories[, "Counts"]
  n <- ncol(x$categories) - 1
  y <- xmeanGam
  pfs = apply(y, 1, function(row) {
    ## (2 / (n+1)) is a factor that normalized the score between 0 and 1
    sum(row * degree / choose(n, degree)) / n * (2 / (n + 1))
  })
  return(pfs)
}


PFSOrig <- PolyfunctionalityScore(COMPASSorig)
PFSCovar <- PolyfunctionalityScore(COMPASScovarV2Lum) %>% as.data.frame()

# OrigCompareDF <- cbind(PFSOrig, PFSOrig2) %>%
#   `colnames<-`(c("PFSRV144", "PFSRV144covar")) %>%
#   rownames_to_column(var="PTID") %>%
# # joining with demographic information
#   inner_join(meta_unfiltered) 

RV144PFS_DF <- 
# bind PFS scores into a dataframe
  cbind(PFSOrig, PFSCovar) %>%
  `colnames<-`(c("PFSRV144", "PFSRV144covar")) %>%
  rownames_to_column(var="PTID") %>%
# joining with demographic information
  inner_join(meta) 
```

We plot these polyfunctionality scores by infection status.

```{r pfs-plot}
#-------------------------------------------
# FUNCTION for PFS boxplots (infected vs. uninfected)
#-------------------------------------------
PFSplot <- function(df){

df %>%
  mutate(event = ifelse(!str_detect(toupper(infect), "NON"),
                        "Infected", "Uninfected")) %>%
  select(event, PTID, PFSRV144, PFSRV144covar) %>%
  pivot_longer(cols = -c(PTID, event), names_to = "Type", values_to = "Value") %>%
  ggplot(aes(x=Type, y = Value, color = event)) + geom_boxplot(outlier.shape = NA) + geom_point(position = position_jitterdodge(0.05, seed = 47)) +
  ylab("Polyfunctional Score")
  
}

#-------------------------------------------
# FUNCTION for PFS scatterplots
#-------------------------------------------
PFSscatterplot <- function(df){

df %>%
    select(infect, PTID, PFSRV144, PFSRV144covar) %>%
  mutate(event = ifelse(!str_detect(toupper(infect), "NON"),
                        "Infected", "Uninfected")) %>%
  ggplot(aes(x=PFSRV144, y=PFSRV144covar)) + geom_point() +
    geom_abline() +
  ylab("Covariate PFS Score") +
    xlab("Original PFS Score")
  
}

PFSplot(RV144PFS_DF)
PFSscatterplot(RV144PFS_DF)
```




### FS Scores

```{r timeFS}
#-------------------------------------------
# FUNCTION for PFS ignoring CD4 vs. CD8 gates
# mean gamma now has burn-in of 0.5
#-------------------------------------------
FunctionalityScore <- function(x, n,markers=NULL, percBurn=0.5) {
  
  xmeanGam <- mean_gam(x$gamma, percBurn) %>%
  `colnames<-`(colnames(x$mean_gamma))
  
  n <- ncol(x$categories) - 1 #subtract counts column
  y <- xmeanGam[, -ncol(x$mean_gamma),drop=FALSE]
  fs = apply(y, 1, function(row) {
    sum(row) / (2^n - 1)
  })
  
}


FSRV144 <- FunctionalityScore(COMPASSorig)[meta$PTID]  %>% as.data.frame() 
FSRV144_covar <- FunctionalityScore(COMPASScovarV2Lum) %>% as.data.frame() 



FSRV144_DF <- 
# bind PFS scores into a dataframe
  cbind(FSRV144, FSRV144_covar) %>%
  `colnames<-`(c("FSRV144","FSRV144covar")) %>%
  rownames_to_column(var="PTID") %>%
# joining with demographic information
  inner_join(meta) 
```

We plot these functionality scores by infection status.

```{r fs-plot}
#-------------------------------------------
# FUNCTION for PFS boxplots (infected vs. uninfected)
#-------------------------------------------
FSplot <- function(df){

df %>%
  mutate(event = ifelse(!str_detect(toupper(infect), "NON"),
                        "Infected", "Uninfected")) %>%
  select(event, PTID, FSRV144, FSRV144covar) %>%
  pivot_longer(cols = -c(PTID, event), names_to = "Type", values_to = "Value") %>%
  ggplot(aes(x=Type, y = Value, color = event)) + geom_boxplot(outlier.shape = NA) + geom_point(position = position_jitterdodge(0.05, seed = 47)) +
  ylab("Functional Score")
  
}

#-------------------------------------------
# FUNCTION for FS scatterplots
#-------------------------------------------
FSscatterplot <- function(df){

df %>%
    select(infect, PTID, FSRV144, FSRV144covar) %>%
  mutate(event = ifelse(!str_detect(toupper(infect), "NON"),
                        "Infected", "Uninfected")) %>%
  ggplot(aes(x=FSRV144, y=FSRV144covar)) + geom_point() +
    geom_abline() +
  ylab("Covariate FS Score") +
    xlab("Original FS Score")
  
}

FSplot(FSRV144_DF)
FSscatterplot(FSRV144_DF)
```


# Rdata Save

We save the COMPASS and COMPASS-covar objects in an Rdata file, after appending their PFS and FS scores to their metadata.

```{r rdat, options}
# datOrig <- list(n_s=n_s, n_u=n_u, meta = meta %>%
#               inner_join(FSRV144_DF %>% select(PTID, FSRV144)) %>%
#               inner_join(RV144PFS_DF %>% select(PTID, PFSRV144)))
# 
# RV144COMPASSOrig = list(fit=COMPASSorig, data=datOrig)
# 
# datCovar <- list(n_s=n_s, n_u=n_u, meta = meta %>%
#               inner_join(FSRV144_DF %>% select(PTID, FSRV144covar)) %>%
#               inner_join(RV144PFS_DF %>% select(PTID, PFSRV144covar)))
# 
# RV144COMPASSCovar = list(fit=COMPASScovarV2Lum, data=datCovar)
# 
# save(RV144COMPASSOrig, RV144COMPASSCovar, file="RV144COMPASS.RData")
```

# Session Info

```{r sessioninfo}

sessionInfo()

```
